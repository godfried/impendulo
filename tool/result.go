//Copyright (c) 2013, The Impendulo Authors
//All rights reserved.
//
//Redistribution and use in source and binary forms, with or without modification,
//are permitted provided that the following conditions are met:
//
//  Redistributions of source code must retain the above copyright notice, this
//  list of conditions and the following disclaimer.
//
//  Redistributions in binary form must reproduce the above copyright notice, this
//  list of conditions and the following disclaimer in the documentation and/or
//  other materials provided with the distribution.
//
//THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND
//ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
//WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
//DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR
//ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
//(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
//LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
//ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
//(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
//SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

package tool

import (
	"labix.org/v2/mgo/bson"
	"strings"
)

const (
	//Some result names.
	NORESULT = "NoResult"
	TIMEOUT  = "Timeout"
	SUMMARY  = "Summary"
	ERROR    = "Error"
	CODE     = "Code"
)

type (
	//Chart represents the x and y values used to draw the charts.
	Chart map[string][]float64

	//ChartResult is used to display result data in a chart.
	ChartResult interface {
		ChartVals() map[string]float64
		GetName() string
		ChartNames() []string
	}
	//ToolResult is used to store tool result data.
	ToolResult interface {
		//Retrieves the result's db id.
		GetId() bson.ObjectId
		//Retrieves the file associated with the result's db id.
		GetFileId() bson.ObjectId
		//Retrieves a summary of this result.
		Summary() *Summary
		//Retrieves this result's tool name.
		GetName() string
		//True if this result is partially stored on GridFS, false otherwise.
		OnGridFS() bool
		//Retrieves the actual data generated by the associated tool stored in this result.
		GetData() interface{}
		//Sets this result's tool data. Used mainly to move data from/to GridFS
		SetData(interface{})
	}

	//DisplayResult is used to display result data.
	DisplayResult interface {
		GetName() string
		GetData() interface{}
	}
	//NoResult is a DisplayResult used to indicate that a
	//Tool provided no result when run.
	NoResult struct{}

	//TimeoutResult is a DisplayResult used to indicate that a
	//Tool timed out when running.
	TimeoutResult struct{}

	//ErrorResult is a DisplayResult used to indicate that an error
	//occured when retrieving a Tool's result.
	ErrorResult struct {
		err error
	}

	//CodeResult is a DisplayResult used to display a source file's code.
	CodeResult struct {
		data string
	}

	//SummaryResult is a DisplayResult used to provide a summary of all results.
	SummaryResult struct {
		summary []*Summary
	}

	//Summary is short summary of a ToolResult's result.
	Summary struct {
		//The tool's name.
		Name string
		//The text to be displayed in the summary.
		Body string
	}
)

//Add inserts new coordinates into data used to display a chart.
func (chart Chart) Add(x float64, ys map[string]float64) {
	if x < 0 {
		x = float64(len(chart["x"]))
	}
	chart["x"] = append(chart["x"], x)
	for name, val := range ys {
		chart[name] = append(chart[name], val)
	}
}

//NewChart initialises new chart data.
func NewChart(names []string) (chart Chart) {
	chart = make(Chart)
	for _, name := range names {
		chart[name] = make([]float64, 0, 100)
	}
	chart["x"] = make([]float64, 0, 100)
	return
}

//Template retrieves a html template for a DisplayResult.
//Each DisplayResult should therefore have two html files which specify how
//its result is displayed. These are called (DisplayResult name)Current.html and
//(DisplayResult name)Next.html. They are almost identical in structure but the one
//will just use .curResult and the other .nextResult when displaying data.
//This is an example (javacNext.html):
//
//{{define "nextResult"}}
//{{$result := .nextResult}}
//{{$header := $result.ResultHeader}}
//{{if $result.Success}}
//<h4 class="text-success">{{$header}}</h4>
//{{else}}
//{{$res := setBreaks $result.Result}}
//{{if $result.Warnings}}
//<h4 class="text-warning">{{$header}}</h4>
//<p class="text-warning">{{$res}}</p>
//{{else}}
//<h4 class="text-danger">{{$header}}</h4>
//<p class="text-danger">{{$res}}</p>
//{{end}}
//{{end}}
//{{end}}
func Template(name string, current bool) string {
	name = strings.ToLower(name)
	if current {
		return name + "Current"
	} else {
		return name + "Next"
	}
}

//GetName
func (this *NoResult) GetName() string {
	return NORESULT
}

//GetData
func (this *NoResult) GetData() interface{} {
	return "No output generated."
}

//GetName
func (this *TimeoutResult) GetName() string {
	return TIMEOUT
}

//GetData
func (this *TimeoutResult) GetData() interface{} {
	return "A timeout occured during execution."
}

//NewErrorResult
func NewErrorResult(err error) *ErrorResult {
	return &ErrorResult{
		err: err,
	}
}

//GetName
func (this *ErrorResult) GetName() string {
	return ERROR
}

//GetData
func (this *ErrorResult) GetData() interface{} {
	return this.err.Error()
}

//NewCodeResult
func NewCodeResult(data []byte) *CodeResult {
	return &CodeResult{
		data: strings.TrimSpace(string(data)),
	}
}

//GetName
func (this *CodeResult) GetName() string {
	return CODE
}

//GetData
func (this *CodeResult) GetData() interface{} {
	return this.data
}

//NewSummaryResult
func NewSummaryResult() *SummaryResult {
	return &SummaryResult{
		summary: make([]*Summary, 0),
	}
}

//GetName
func (this *SummaryResult) GetName() string {
	return SUMMARY
}

//GetData
func (this *SummaryResult) GetData() interface{} {
	return this.summary
}

//AddSummary adds a ToolResult's summary to this SummaryResult's
//list of summaries.
func (this *SummaryResult) AddSummary(result ToolResult) {
	this.summary = append(this.summary, result.Summary())
}
